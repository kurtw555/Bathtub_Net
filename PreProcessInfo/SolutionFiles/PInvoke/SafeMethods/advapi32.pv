(%unit (%imports (%import "System") (%import "System.Runtime.InteropServices") (%import "System.Drawing") (%import "UpgradeHelpers.Helpers")) (%package "SafeNative") (%module "advapi32" (%public) (%method "RegCloseKey" (%int) (%args (%variable (%byval) (%var "hKey") (%int))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.advapi32.RegCloseKey") (%param (%id "hKey")))]) (%public)) (%method "RegCreateKeyEx" (%int) (%args (%variable (%byval) (%var "hKey") (%int)) (%variable (%byref) (%var "lpSubKey") (%string)) (%variable (%byval) (%var "Reserved") (%int)) (%variable (%byref) (%var "lpClass") (%string)) (%variable (%byval) (%var "dwOptions") (%int)) (%variable (%byval) (%var "samDesired") (%int)) (%variable (%byref) (%var "lpSecurityAttributes") (%user-type "BT2Support.UnsafeNative.Structures.SECURITY_ATTRIBUTES")) (%variable (%byref) (%var "phkResult") (%int)) (%variable (%byref) (%var "lpdwDisposition") (%int))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.advapi32.RegCreateKeyEx") (%param (%id "hKey") (%id "lpSubKey") (%id "Reserved") (%id "lpClass") (%id "dwOptions") (%id "samDesired") (%id "lpSecurityAttributes") (%id "phkResult") (%id "lpdwDisposition")))]) (%public)) (%method "RegDeleteValue" (%int) (%args (%variable (%byval) (%var "hKey") (%int)) (%variable (%byref) (%var "lpValueName") (%string))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.advapi32.RegDeleteValue") (%param (%id "hKey") (%id "lpValueName")))]) (%public)) (%method "RegEnumKey" (%int) (%args (%variable (%byval) (%var "hKey") (%int)) (%variable (%byval) (%var "dwIndex") (%int)) (%variable (%byref) (%var "lpName") (%string)) (%variable (%byval) (%var "cbName") (%int))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.advapi32.RegEnumKey") (%param (%id "hKey") (%id "dwIndex") (%id "lpName") (%id "cbName")))]) (%public)) (%method "RegEnumValue" (%int) (%args (%variable (%byval) (%var "hKey") (%int)) (%variable (%byval) (%var "dwIndex") (%int)) (%variable (%byref) (%var "lpValueName") (%string)) (%variable (%byref) (%var "lpcbValueName") (%int)) (%variable (%byval) (%var "lpReserved") (%int)) (%variable (%byref) (%var "lpType") (%int)) (%variable (%byval) (%var "lpData") (%int)) (%variable (%byref) (%var "lpcbData") (%int))) (%seq (%variable-list (%variable (%var "result" (%init-value 0)) (%int))) (%variable (%var "handle" (%init-value (%call (%id "GCHandle.Alloc") (%param (%id "lpData") (%id "GCHandleType.Pinned"))))) (%user-type "GCHandle")) (%try (%seq (%variable (%var "tmpPtr" (%init-value (%call (%dot (%id "handle") (%id "AddrOfPinnedObject")) (%param)))) (%user-type "IntPtr")) (%= (%id "result") (%call (%id "BT2Support.UnsafeNative.advapi32.RegEnumValue") (%param (%id "hKey") (%id "dwIndex") (%id "lpValueName") (%id "lpcbValueName") (%id "lpReserved") (%id "lpType") (%id "tmpPtr") (%id "lpcbData")))) (%= (%id "lpData") (%call (%id "Marshal.ReadInt32") (%param (%id "tmpPtr"))))) (%finally (%seq (%call (%dot (%id "handle") (%id "Free")) (%param))))) [%return (%id "result")]) (%public)) (%method "RegOpenKeyEx" (%int) (%args (%variable (%byval) (%var "hKey") (%int)) (%variable (%byref) (%var "lpSubKey") (%string)) (%variable (%byval) (%var "ulOptions") (%int)) (%variable (%byval) (%var "samDesired") (%int)) (%variable (%byref) (%var "phkResult") (%int))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.advapi32.RegOpenKeyEx") (%param (%id "hKey") (%id "lpSubKey") (%id "ulOptions") (%id "samDesired") (%id "phkResult")))]) (%public)) (%method "RegQueryValue" (%int) (%args (%variable (%byval) (%var "hKey") (%int)) (%variable (%byref) (%var "lpSubKey") (%string)) (%variable (%byref) (%var "lpValue") (%string)) (%variable (%byref) (%var "lpcbValue") (%int))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.advapi32.RegQueryValue") (%param (%id "hKey") (%id "lpSubKey") (%id "lpValue") (%id "lpcbValue")))]) (%public)) (%method "RegQueryValueEx" (%int) (%args (%variable (%byval) (%var "hKey") (%int)) (%variable (%byref) (%var "lpValueName") (%string)) (%variable (%byval) (%var "lpReserved") (%int)) (%variable (%byref) (%var "lpType") (%int)) (%variable (%byref) (%var "lpData") (%string)) (%variable (%byref) (%var "lpcbData") (%int))) (%seq (%variable-list (%variable (%var "result" (%init-value 0)) (%int))) (%variable (%var "tmpPtr" (%init-value (%call (%id "Marshal.StringToHGlobalAnsi") (%param (%id "lpData"))))) (%user-type "IntPtr")) (%try (%seq (%= (%id "result") (%call (%id "BT2Support.UnsafeNative.advapi32.RegQueryValueEx") (%param (%id "hKey") (%id "lpValueName") (%id "lpReserved") (%id "lpType") (%id "tmpPtr") (%id "lpcbData")))) (%= (%id "lpData") (%call (%id "Marshal.PtrToStringAnsi") (%param (%id "tmpPtr"))))) (%finally (%seq (%call (%id "Marshal.FreeHGlobal") (%param (%id "tmpPtr")))))) [%return (%id "result")]) (%public)) (%method "RegSetValueEx" (%int) (%args (%variable (%byval) (%var "hKey") (%int)) (%variable (%byref) (%var "lpValueName") (%string)) (%variable (%byval) (%var "Reserved") (%int)) (%variable (%byval) (%var "dwType") (%int)) (%variable (%byref) (%var "lpData") (%string)) (%variable (%byval) (%var "cbData") (%int))) (%seq (%variable-list (%variable (%var "result" (%init-value 0)) (%int))) (%variable (%var "tmpPtr" (%init-value (%call (%id "Marshal.StringToHGlobalAnsi") (%param (%id "lpData"))))) (%user-type "IntPtr")) (%try (%seq (%= (%id "result") (%call (%id "BT2Support.UnsafeNative.advapi32.RegSetValueEx") (%param (%id "hKey") (%id "lpValueName") (%id "Reserved") (%id "dwType") (%id "tmpPtr") (%id "cbData")))) (%= (%id "lpData") (%call (%id "Marshal.PtrToStringAnsi") (%param (%id "tmpPtr"))))) (%finally (%seq (%call (%id "Marshal.FreeHGlobal") (%param (%id "tmpPtr")))))) [%return (%id "result")]) (%public))))