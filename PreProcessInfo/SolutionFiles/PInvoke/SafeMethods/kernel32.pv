(%unit (%imports (%import "System") (%import "System.Runtime.InteropServices") (%import "System.Drawing") (%import "UpgradeHelpers.Helpers")) (%package "SafeNative") (%module "kernel32" (%public) (%method (%generic-id "CopyMem" (%user-type "T")) (%void) (%args (%variable (%byref) (%var "Destination") (%user-type "T")) (%variable (%byval) (%var "Source") (%int)) (%variable (%byval) (%var "Length") (%int))) (%seq (%variable (%var "handle2" (%init-value (%call (%id "GCHandle.Alloc") (%param (%id "Source") (%id "GCHandleType.Pinned"))))) (%user-type "GCHandle")) (%try (%seq (%variable (%var "tmpPtr2" (%init-value (%call (%dot (%id "handle2") (%id "AddrOfPinnedObject")) (%param)))) (%user-type "IntPtr")) (%variable (%var "tmpPtr" (%init-value (%call (%id "Marshal.AllocHGlobal") (%param (%call (%id "Marshal.SizeOf") (%param (%id "Destination"))))))) (%user-type "IntPtr")) (%call (%id "Marshal.StructureToPtr") (%param (%id "Destination") (%id "tmpPtr") (%true))) (%call (%id "BT2Support.UnsafeNative.kernel32.CopyMem") (%param (%id "tmpPtr") (%id "tmpPtr2") (%id "Length"))) (%= (%id "Source") (%call (%id "Marshal.ReadInt32") (%param (%id "tmpPtr2")))) (%= (%id "Destination") (%call (%id "CType") (%param (%call (%id "Marshal.PtrToStructure") (%param (%id "tmpPtr") (%call (%dot (%id "Destination") (%id "GetType")) (%param)))) (%user-type "T"))))) (%finally (%seq (%call (%dot (%id "handle2") (%id "Free")) (%param)))))) (%generic-constraint-where "T" (%generic-constraint-struct)) (%public)) (%method "ExpandEnvironmentStrings" (%int) (%args (%variable (%byref) (%var "lpSrc") (%string)) (%variable (%byref) (%var "lpDst") (%string)) (%variable (%byval) (%var "nSize") (%int))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.kernel32.ExpandEnvironmentStrings") (%param (%id "lpSrc") (%id "lpDst") (%id "nSize")))]) (%public)) (%method "FindClose" (%int) (%args (%variable (%byval) (%var "hFindFile") (%int))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.kernel32.FindClose") (%param (%id "hFindFile")))]) (%public)) (%method "FindFirstFile" (%int) (%args (%variable (%byref) (%var "lpFileName") (%string)) (%variable (%byref) (%var "lpFindFileData") (%user-type "BT2Support.UnsafeNative.Structures.WIN32_FIND_DATA"))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.kernel32.FindFirstFile") (%param (%id "lpFileName") (%id "lpFindFileData")))]) (%public)) (%method "GetLongPathName" (%int) (%args (%variable (%byref) (%var "pszShortPath") (%string)) (%variable (%byref) (%var "lpszLongPath") (%string)) (%variable (%byval) (%var "cchBuffer") (%int))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.kernel32.GetLongPathName") (%param (%id "pszShortPath") (%id "lpszLongPath") (%id "cchBuffer")))]) (%public)) (%method "GetVersionExA" (%short) (%args (%variable (%byref) (%var "lpVersionInformation") (%user-type "BT2Support.UnsafeNative.Structures.OSVERSIONINFO"))) (%seq [%return (%call (%id "BT2Support.UnsafeNative.kernel32.GetVersionExA") (%param (%id "lpVersionInformation")))]) (%public))))